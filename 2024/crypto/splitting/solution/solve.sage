from Crypto.Util.number import *
import timeout_decorator

# discrete_log version

# -----------------------------------------------------------
# challenge part
# -----------------------------------------------------------

FLAG = b"IERAE{7de6b745404269a0d7b40955047921c6860e4438c73eb095090e75c8fb00cb51}"
f = bytes_to_long(FLAG)

p = random_prime(2^128)
Fp = GF(p)
a, b = Fp.random_element(), Fp.random_element()
E = EllipticCurve(Fp, [a, b])

print(a)
print(b)
print(p)

gens = list(E.gens())
if len(gens) < 2:
    gens.append(ZZ(Fp.random_element()) * E.gens()[0])

res = []
while f > 0:
    r = Fp.random_element()
    res.append(ZZ(r) * gens[f & 1])
    f >>= 1

for R in res:
    print(R.xy())


# -----------------------------------------------------------
# attack part
# -----------------------------------------------------------

inputs = []
a, b, p = a, b, p
for R in res:
    inputs.append((ZZ(R.xy()[0]), ZZ(R.xy()[1])))
Fp = GF(p)
E = EllipticCurve(Fp, [a, b])

gens = E.gens()

assert len(gens) == 2, "not split"

@timeout_decorator.timeout(1)
def test(R, G):
    discrete_log(R, G, operation="+")

res = []
for R in inputs:
    R = E(R)

    try:
        test(R, gens[0])
    except ValueError:
        e0 = 2
    except timeout_decorator.timeout_decorator.TimeoutError:
        e0 = 1

    try:
        test(R, gens[1])
    except ValueError:
        e1 = 2
    except timeout_decorator.timeout_decorator.TimeoutError:
        e1 = 1

    if e0 == 1 and e1 != 1:
        res.append("0")
    elif e0 != 1 and e1 == 1:
        res.append("1")
    else:
        res.append("2")
    print("res:", res, len(res))


res.reverse()
print("?? count:", res[47:-8].count("2"))
print("".join(res)[47:-8])

# -----------------------------------------------------------
# search part
# -----------------------------------------------------------
"""
?? count: 184
20110212022222220110012102222222212000100222222200120220002102010022212000220000202102020012001020220112002210212110000100210000021001000022022102220022001102020022000000111002002221010222010202110020202202000211011222212022002120120021202201102011001201200022122020120210001100000222022102112200001101000011001100212000021000122012222200220211011002022220021002222020002210020012210120120000022210020022000202100101001122220012220102100021002120000210012021200010001120002022200202200222021002200021020100110201
?? count: 255
22112211021001222210010120212110212222202022021102122122202201012222222200110000202202202222201220220220221220212212220202220200011222202021211202200212221102220222222002112002221222212021222100110200002201020012212122211001002120220211200201102221002202122222222222110110021200202222010220212102222202202011222220211022221202210212022202110022012022022222022020122000022222010222010102220020021212210022002201120202201121110021022102100222021220200210211221120010021100220221000022120212221020120222012100120221
...
"""

targets = ["20110212022222220110012102222222212000100222222200120220002102010022212000220000202102020012001020220112002210212110000100210000021001000022022102220022001102020022000000111002002221010222010202110020202202000211011222212022002120120021202201102011001201200022122020120210001100000222022102112200001101000011001100212000021000122012222200220211011002022220021002222020002210020012210120120000022210020022000202100101001122220012220102100021002120000210012021200010001120002022200202200222021002200021020100110201", "22112211021001222210010120212110212222202022021102122122202201012222222200110000202202202222201220220220221220212212220202220200011222202021211202200212221102220222222002112002221222212021222100110200002201020012212122211001002120220211200201102221002202122222222222110110021200202222010220212102222202202011222220211022221202210212022202110022012022022222022020122000022222010222010102220020021212210022002201120202201121110021022102100222021220200210211221120010021100220221000022120212221020120222012100120221",
"00210212022002000210010100120210012000100022212100120100001102020012010000210000001102000021002000120120001220020120000100110000012001000011021101100020001102000022002000112001001201010012010100220020002101000021021200221202002200102022000102100022001102100011200000210110001100000220020200220200001102000021001100222000021000120021011100210021022002020120002000122000001110020022020200120000002220010022000001200221002101110022020102100012001110000110012001200010002200000012000002100022011000200021010200110002", "22110122012222200110222222212120222200200222212122122202222222210212220220120022201102200212002000112212021112012212020202110020011201002022221101102020022121200012200022221221222101222021220222210222021201000221012100222202002200100012000121100222201101202011100002112112001122020120010222120120201102222021202102222002222022110012022122212021222202020112222200222220001220020212010202122220201210012022200022120202222121212211220101220021021112000222222002120210022102020011022202202011022020222021020122122202","02110221021021200210220202212112011222222221211102212120021122212222222002220220022222000012222022112210201210220122222222120202212201222221212201120222002201022022002222121021202201220222012200212222222121200221221200221201002222100021000121100211221202220012200202222122002122200212022102120102221221000012202102222200221202210221211100220021212022012220202020222202001120220022212102220000022110222222200222202122222202210212020102220212022122002222212002120212221202022021022002222212011002102212222120120021", "02110112012001002120220200112210012200100021012202120102001122020011020000110020001221000211201000220222001210020210002100210000222001200021011101200010001202000022000222211001001202010011010200120000001102000021021120222002002200100011000102200022002102120021200000220112022200000210020100220200221201000011002200212000212000110021012100210212022001010210001200110020002220020012020120120000002220210021220022200202002202210011220101202011022222200120022002100020001100000021000201102022021202100021010120220001", "02112111212222200220212200110222221222120012212200112200002102220022020200122022001101200221021000122212022210022112200122220200221221022021221221100020021221000222222200212001002121020012012222120222002202200021012120122002201120100222200122102222001121122012220000222220222102222210010120222222222102002212001220121202221002110211012122222222021202222222022002122202022212012011010120210000222210212021222201122222002122212222020201120222002112002220021202202220022202220021000201200221221022122211210202220022", "02120111212021202220022102222110022202120011222200120102001102222021010002210200001221020011001220212112001222210210022220112220011201000221212121122220001202020211000020112022202101022212010200120022001121200221221200211221221102222222020101102211201201220022220200122110222202020212022200120122201122222021222220121200222222222022012122212021211201222220202222120202022220210022210200120200201220220221022222202121201102122212022102202012222120002210011201220220022220220212000222100022211002202222012120110202", "22110212022202200220010100122210012200202012022200112100001102010022012000222000022202000022002002212110002112210110002200212202021002002212212222202022002101222012020000122022001102010011010100212000022202020221222102221001001200102012202102202011201202200212102000212220202102200222020200120220001102020022222100122222012202212212012220220212021021010110002000220200221122020021220200120000201120022222200001100201201102110012012121200022002210000210011022200012222122020021000001120221211200200011210200210201", "00220111012001000120010200120120011000202022021100110200002201020021010000120000001201000011002000120120002110010120000200210000022002000021022102200020002202000021000000221002001102010022010200110000001101000011011100221001002200100012000202100022001101100012100000110110001100000112010100120200001201000012002100112000011000110021021200120012012001010110002000210000001110020022010200110000002110020011000001200201001201120022010121200011002220000120012001200220001100000012000002100221021000100012020100210002"]

target = ""
for i in range(len(targets[0])):
    res = "2"
    for j in targets:
        if j[i] == "0":
            res = "0"
            break
        elif j[i] == "1":
            res = "1"
            break
    target += res

print("?? count:", target.count("2"))
print(b"IERAE{" + long_to_bytes(int(target, 2)) + b"}")
