from Crypto.Util.number import *

# -----------------------------------------------------------
# challenge part
# -----------------------------------------------------------

FLAG = b"IERAE{7de6b745404269a0d7b40955047921c6860e4438c73eb095090e75c8fb00cb51}"
f = bytes_to_long(FLAG)

p = random_prime(2^128)
Fp = GF(p)
a, b = Fp.random_element(), Fp.random_element()
E = EllipticCurve(Fp, [a, b])

print(a)
print(b)
print(p)

gens = list(E.gens())
if len(gens) < 2:
    gens.append(ZZ(Fp.random_element()) * E.gens()[0])

res = []
while f > 0:
    r = Fp.random_element()
    res.append(ZZ(r) * gens[f & 1])
    f >>= 1

for R in res:
    print(R.xy())


# -----------------------------------------------------------
# attack part
# -----------------------------------------------------------

inputs = []
a, b, p = a, b, p
for R in res:
    inputs.append((ZZ(R.xy()[0]), ZZ(R.xy()[1])))
Fp = GF(p)
E = EllipticCurve(Fp, [a, b])

gens = E.gens()

assert len(gens) == 2, "not split"

o1 = gens[1].order()
o0 = gens[0].order()
res = []
for R in inputs:
    R = E(R)
    try:
        e0 = gens[0].weil_pairing(R, o0)
    except:
        e0 = gens[0].weil_pairing(R, o1)
    try:
        e1 = gens[1].weil_pairing(R, o1)
    except:
        e1 = gens[1].weil_pairing(R, o0)
    if e0 == 1 and e1 != 1:
        res.append("0")
    elif e0 != 1 and e1 == 1:
        res.append("1")
    else:
        res.append("2")

res.reverse()
print("?? count:", res[47:-8].count("2"))
print("".join(res)[47:-8])

# -----------------------------------------------------------
# search part
# -----------------------------------------------------------
"""
?? count: 242
02110121021222200110210120112212221200222221011102110100221102220211020020110020202121002022021202210210221112020212200220120002221002020021021121100020001222020012022020221221001201212221020100210200222221002211211200112221021122202222202122122222001222200012222002212220202202222210222120212220002222000221201100121022222000210022212220220022211002022220222020222002202110210211010100122000022122212011020002222102001222122012012222100011202220202220011022202212202120000022200001222212221222122212212100210201
?? count: 252
00110222012202222112222100222212011002120022222202110202201202022222212020112020202102020011002002120212221122212112000102210202021022020212212121100012001221022012220002211001201121012022020202120220221202002012212222121222201202122021200102220212202101122021102002110110222122022110222102110122222122220221221222122002011220212221012202122022211221210122022000212020001222212211210200122200201222220022202001122202022221122022210121202022202120020220022021122012022120220012020001220012222200202022012100110022
...
"""

targets = ["02110121021222200110210120112212221200222221011102110100221102220211020020110020202121002022021202210210221112020212200220120002221002020021021121100020001222020012022020221221001201212221020100210200222221002211211200112221021122202222202122122222001222200012222002212220202202222210222120212220002222000221201100121022222000210022212220220022211002022220222020222002202110210211010100122000022122212011020002222102001222122012012222100011202220202220011022202212202120000022200001222212221222122212212100210201", "00110222012202222112222100222212011002120022222202110202201202022222212020112020202102020011002002120212221122212112000102210202021022020212212121100012001221022012220002211001201121012022020202120220221202002012212222121222201202122021200102220212202101122021102002110110222122022110222102110122222122220221221222122002011220212221012202122022211221210122022000212020001222212211210200122200201222220022202001122202022221122022210121202022202120020220022021122012022120220012020001220012222200202022012100110022", "20210112022021000110020102220220211022100222012102212102201102222211220220210002201101002212022220220212001210220212022102122000021222022011211121122210222102200221202000111202021201020221012100220000022222002222211122212222002202102212022222100021002122222211202022222210021202002112022102220222221121202221202222112002012202122212222122120221012002222210221200222002222112020011010102120200202120012212222022202221022202122212212202202212001212222222011021102222221122220212022222100212021020220022220122220002", "00110111021202020110010200110110011000102021011100120102001201210011020200220000001201000012001000110120001120020212000100110002021201000012021202100010001222000011000000112001002201010022012100210000002101000011012100111001001100100212002201100011001201100011200000110110001100020212020220110200001101000011001200221022021002120012011200112012021002010210002020122020021110010212020220210000001110010012000202100102001101110021010102100021001120000212212022100210201120000022000001100021012000100012020100110002", "22212112011222022212020200122120021222202222012200110102001202020011212002112200001102002022221002220222002210020210202102112002011002002221012201100010021121200212202222122001022221012212022222210002202102220221011100212022022100220221000221222212002202200012200220210210001202022112012102220222021222002222201220112200222000120011011100112022212222020112002002112002022222010011212220122000021112210011220221120222001201120221010121200011001122222210012001122212021222022222220222102021011220122012022220210222", "02220222011002000112012100210110011222120212021200122122021201022021010202122000001202022211202220110212221210012212200200120222021001220212222102200012002101020021020020111002222102220212010200220002001201002221211200122202001202122211002101100212021121100212122000122110221120020210010120112220021221222211002200111200022020210012021200120021022222010122022220120000221210010021020202120002222220012021000001200101202201110012010122102022001210200220021221120022201120002021222021200211021000200022212120222022", "00110121221001000112022120210110011000200012012100110100001101010211010000110002001201000021021000110112002110010120000220110000021002000011011101200012201101020211002020111001001201212211010102110020001201200011021100111201001100100021000121100012001101102012200000110110001100000110010100110100001201000011021100111000211002110011012100112021011002010112021000110000001110010011010200110000001110010011222001100101001101110011010102202011201110200220011021100012001202000011000021100011011000100211010100110002", "00220121012001002122212102210120022000100012211200120220202122010012020002110000221201000222001200212220201112020210002200112000021201200012011202122010002221020211000000121021001201020022220100120020002221200021022100111001002100100221022201222011002101220022200000112110201202000110220202212102202101000011001100221020221002110011022200120011211221020210002200210002002210210022220200222002002110010011020021200202002102212021010102100011001220220112221201220010202100000022000022102211022220200021210220110002"]

target = ""
for i in range(len(targets[0])):
    res = "2"
    for j in targets:
        if j[i] == "0":
            res = "0"
            break
        elif j[i] == "1":
            res = "1"
            break
    target += res

print("?? count:", target.count("2"))
print(b"IERAE{" + long_to_bytes(int(target, 2)) + b"}")